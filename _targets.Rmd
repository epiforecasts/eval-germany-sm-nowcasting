---
title: "Supplementary information"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```


# Setup

Set up the workflow pipeline and options. We first load the `targets` package and remove the potentially outdated workflow.

```{r}
library(targets)
library(tarchetypes)
library(tibble)
library(tidyr)
library(dplyr)
library(scoringutils)
library(ggplot2)
library(purrr)
library(here)
tar_unscript()
```

We now define shared global options across our workflow and load R functions from the `R` folder.


```{targets globals, tar_globals = TRUE}
library(purrr)
library(here)
library(tarchetypes)
functions <- list.files(here("R"), full.names = TRUE)
walk(functions, source)
tar_option_set(
  packages = c("data.table", "epinowcast", "scoringutils", "ggplot2", "purrr",
               "cmdstanr"),
  deployment = "worker",
  memory = "transient",
  workspace_on_error = TRUE,
  error = "continue",
  garbage_collection = TRUE
)
```

# Ingest data and stratify by location and report date

* Download and process hospitalisation data.

```{targets hospitalisations, tar_simple = TRUE}
get_germany_hospitalisations()
```

* Download and process public holidays data.

* Define dates to nowcast.

```{targets nowcast_dates, tar_simple = TRUE}
unique(
  hospitalisations[reference_date >= as.Date("2021-09-01")]$reference_date
)[1:7]
```

* Define age groups

```{targets age_groups, tar_simple = TRUE}
unique(hospitalisations$age_group)
```

* Define locations to nowcast

```{targets locations, tar_simple = TRUE}
unique(hospitalisations$location)[1]
```

* Define maximum allowed reporting delay (in days).

```{targets max_report_delay, tar_simple = TRUE}
40
```

* Define hospitalisations by date of report

```{targets hospitalisations_by_date_report}
tar_target(
    hospitalisations_by_date_report,
    enw_retrospective_data(
      hospitalisations, rep_date = nowcast_dates,
      ref_days = max_report_delay
  )[, nowcast_date := nowcast_dates],
  map(nowcast_dates)
)
```

* Define latest available data.

```{targets latest_hospitalisations, tar_simple = TRUE}
 enw_latest_data(hospitalisations)
```

* Plot reporting delay percentage by date, location, and age group.

# Fit models and produce nowcast

## Model and model settings

* Compile the model for multithread use.

```{targets, epinowcast_model}
tar_target(
  epinowcast_model,
  compile_model(threads = TRUE),
  format = "file", deployment = "main",
)
```
* Define stan settings shared across models and used for fitting

```{targets epinowcast_settings, tar_simple = TRUE}
list(
  save_warmup = FALSE,
  output_loglik = FALSE,
  pp = FALSE,
  iter_warmup = 1000,
  iter_sampling = 2000,
  chains = 2,
  threads_per_chain = 2,
  adapt_delta = 0.95,
  show_messages = FALSE
)
```
## Models

* Intercept only model.

```{targets, fixed_nowcast}
tar_target(
  fixed_nowcast,
  do.call(
    fixed_epinowcast, c(
      list(
        obs = hospitalisations,
        max_delay = max_report_delay,
        model_file = epinowcast_model
      ),
      epinowcast_settings
    )
  ),
  cross(nowcast_dates, location)
)
```

* Intercept model with day of the week reporting effects.

* Age group random effect model with day of the week effect reporting effects.

* Age group random effect model with a weekly random walk and a day of the week reporting effect.

* Age group random effect model with a weekly random walk, an age group specific weekly random walk in the residuals,  and a day of the week reporting effect.

* Independent age group model with a weekly random walk and a day of the week reporting model.

# Postprocess

* Make nowcasts into 7 day incidence.

* Make latest observations into 7 day incidence.

* Save nowcasts stratified by nowcasting date.

* Format nowcasts for hub submission.

# Visualise

* Plot most recent nowcast by location, age group, and model.

* Plot nowcasts at 0 horizon by location, age group, and model.

* Plot nowcasts at 3 day horizon by location, age group and model

# Evaluation

* Score nowcasts overall both on a natural scale and on a log scale.

* Score nowcasts by location on a natural scale and on a log scale.

* Score nowcasts by age group on a natural scale and on a log scale.

* Score nowcasts by horizon on a natural scale and on a log scale.

* Plot scores relative to the baseline by location and age group on both the natural and log scale.

# Reporting

* Render nowcast report.

# Pipeline

The pipeline can be regenerated by rendering this file,

```{r, eval = FALSE}
rmarkdown::render("_targets.Rmd")
```

The pipeline can then be run using,

```{r, eval = FALSE}
tar_make()
```

The complete pipeline can be visualised using,

```{r, eval = FALSE}
tar_visnetwork()
```

The pipeline can be regenerated and run using the following single step

```{bash, eval = FALSE}
. _targets.sh
```

Alternatively the pipeline can be explored interactively using this notebook.
