---
title: "Supplementary information"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```


# Pipeline

The analysis pipeline for this work can be regenerated by rendering this file,

```{r, eval = FALSE}
rmarkdown::render("_targets.Rmd")
```

The pipeline can then be run using,

```{r, eval = FALSE}
tar_make()
```

The complete pipeline can be visualised using,

```{r, eval = FALSE}
tar_visnetwork()
```

The pipeline can be regenerated and run using the following single step

```{bash, eval = FALSE}
. _targets.sh
```

Alternatively the pipeline can be explored interactively using this notebook.


# Setup

Set up the workflow pipeline and options. We first load the `targets` package and remove the potentially outdated workflow.

```{r}
library(targets)
library(tarchetypes)
library(data.table)
library(epinowcast)
library(ggplot2)
library(purrr, quietly = TRUE)
library(here)
library(future)
library(future.callr)
tar_unscript()
```

We now define shared global options across our workflow and load R functions from the `R` folder.


```{targets globals, tar_globals = TRUE}
library(targets)
library(tarchetypes)
library(data.table)
library(epinowcast)
library(ggplot2)
library(purrr, quietly = TRUE)
library(here)
library(future)
library(future.callr)
plan(callr)
functions <- list.files(here("R"), full.names = TRUE)
walk(functions, source)
rm("functions")
tar_option_set(
  packages = c("data.table", "epinowcast", "scoringutils", "ggplot2", "purrr",
               "cmdstanr", "here"),
  deployment = "worker",
  memory = "transient",
  workspace_on_error = TRUE,
  error = "continue",
  garbage_collection = TRUE
)
```

# Ingest data and stratify by location and report date

* Specify todays date to trigger downloading new data.

```{targets today, tar_globals = TRUE}
today <- Sys.Date()
```

* Download and process hospitalisation data. Also download and combined data on public holidays in Germany.

```{targets hospitalisations, tar_simple = TRUE}
get_germany_hospitalisations(today)
```

* Define date to start nowcasting

```{targets start_date, tar_simple = TRUE}
as.Date("2021-10-01")
```

* Define dates to nowcast.

```{targets nowcast_dates, tar_simple = TRUE}
unique(
  hospitalisations[reference_date >= start_date]$reference_date
)
```

* Define age groups

```{targets age_groups, tar_simple = TRUE}
unique(hospitalisations$age_group)
```

* Define locations to nowcast (currently limited to just national level).

```{targets locations, tar_simple = TRUE}
"DE"
```

* Define maximum allowed reporting delay (in days).

```{targets max_report_delay, tar_simple = TRUE}
40
```

* Define hospitalisations by date of report

```{targets hospitalisations_by_date_report}
tar_target(
  hospitalisations_by_date_report,
  enw_retrospective_data(
    hospitalisations, rep_date = nowcast_dates,
    ref_days = max_report_delay
  )[, nowcast_date := nowcast_dates],
  map(nowcast_dates),
  iteration = "list"
)
```

* Define latest available data.

```{targets latest_hospitalisations, tar_simple = TRUE}
 enw_latest_data(hospitalisations)
```

* Make latest observations into 7 day incidence.

```{targets, latest_7day_hospitalisations, tar_simple = TRUE}
copy(latest_hospitalisations)[,
  confirm := frollsum(confirm, n =  7), by = c("age_group", "location")
][!is.na(confirm)]
```

* Define "complete" data (i.e more than 28 days have passed since first reported)

```{targets, complete_hospitalisations, tar_simple = TRUE}
latest_hospitalisations[reference_date < (report_date - 28)][,
                        horizon := as.numeric(reference_date - report_date)]
```

* Similarly, define "complete" 7 day hospitalisation incidence.

```{targets, complete_7day_hospitalisations, tar_simple = TRUE}
latest_7day_hospitalisations[reference_date < (report_date - 28)][,
                             horizon := as.numeric(reference_date - report_date)
                            ]
```

* Plot reporting delay percentage by date, location, and age group.

# Fit models and produce nowcasts

## Model and model settings

* Compile the model for multithread use.

```{targets, epinowcast_model}
tar_target(
  epinowcast_model,
  compile_model(),
  format = "file", deployment = "main",
)
```
* Define stan settings shared across models and used for fitting

```{targets epinowcast_settings, tar_simple = TRUE}
list(
  save_warmup = FALSE,
  output_loglik = FALSE,
  pp = FALSE,
  iter_warmup = 1000,
  iter_sampling = 1000,
  chains = 2,
  parallel_chains = 2,
  threads_per_chain = 1,
  adapt_delta = 0.9,
  show_messages = FALSE,
  refresh = 0
)
```

## Priors

* Define a set of uninformed priors using the defaults from `epinowcast`.

```{targets uninformed_priors, tar_simple = TRUE}
enw_priors()
```

* Define a set of observations to use as a source for informed priors. Here we use overall national hospitalisations and data from the 1st of July 2021.

```{targets prior_obs, tar_simple = TRUE}
enw_retrospective_data(
  hospitalisations[location == "DE"][age_group == "00+"],
  rep_date = as.Date("2021-07-01"), ref_days = max_report_delay
)
```

* Fit a model to national overall hospitalisations only and extract posterior estimates for the delay distribution and overdispersion to use as informed priors for other models by assuming a normal distribution with their posterior standard deviations scaled by 5 times.

```{targets priors, tar_simple = TRUE} 
do.call(prior_epinowcast, c(
  list(
    prior_obs, max_delay = max_report_delay, scale = 5,
    priors = uninformed_priors
  ),
  epinowcast_settings
))
```

## Models

* Intercept only model.

```{targets fixed_nowcast}
tar_target(
  fixed_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = fixed_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Intercept model with day of the week reporting effects.

```{targets dow_nowcast}
tar_target(
  dow_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = dow_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with day of the week effect reporting effects.

```{targets age_nowcast}
tar_target(
  age_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = age_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with a weekly random walk and a day of the week reporting effect.

```{targets week_nowcast}
tar_target(
  week_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = week_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with a weekly random walk, an age group specific weekly random walk in the residuals,  and a day of the week reporting effect.

```{targets age_week_nowcast}
tar_target(
  age_week_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = age_week_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Independent age group model with a weekly random walk and a day of the week reporting model.

```{targets independent_nowcast}
tar_target(
  independent_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report[age_group == age_groups],
    tar_loc = locations,
    model = independent_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations, age_groups)
)
```

# Postprocess

* Combine nowcasts from each model

```{targets combined_nowcasts, tar_simple = TRUE}
rbindlist(list(
  fixed_nowcast,
  dow_nowcast,
  age_nowcast,
  week_nowcast,
  age_week_nowcast,
  independent_nowcast
))[,
   model := factor(
    model,
    levels = c("Reference: Fixed, Report: Fixed",
               "Reference: Fixed, Report: Day of week",
               "Reference: Age, Report: Day of week",
               "Reference: Age and week, Report: Day of week",
               "Reference: Age and week by age, Report: Day of week",
               "Independent by age, Reference: Week, Report: Day of week")
   )
  ]
```

* Extract summarised daily nowcast

```{targets summarised_nowcast, tar_simple = TRUE}
combined_nowcasts[, rbindlist(daily), by = c("model", "nowcast_date")]
```

* Extract summarised 7 day nowcast

```{targets summarised_7day_nowcast, tar_simple = TRUE}
combined_nowcasts[, rbindlist(seven_day), by = c("model", "nowcast_date")]
```

* Save daily nowcasts stratified by nowcasting date.

```{targets save_daily_nowcasts}
tar_target(
  save_daily_nowcasts,
  summarised_nowcast[nowcast_date == nowcast_dates] |>
    save_csv(
      filename = paste0(nowcast_dates, ".csv"),
      path = here("data/nowcasts/daily")
    ),
  map(nowcast_dates),
  format = "file"
)
```

* Save 7 day nowcasts stratified by nowcasting date

```{targets save_7day_nowcasts}
tar_target(
  save_7day_nowcasts,
  summarised_7day_nowcast[nowcast_date == nowcast_dates] |>
    save_csv(
      filename = paste0(nowcast_dates, ".csv"),
      path = here("data/nowcasts/seven_day")
    ),
  map(nowcast_dates),
  format = "file"
)
```

* Define and format the hierarchical nowcast for submission.

```{targets hierarchical_submission_nowcast}
tar_target(
  hierarchical_submission_nowcast,
  age_week_nowcast[nowcast_date == nowcast_dates]$seven_day |>
    rbindlist() |>
    format_for_submission(),
  map(nowcast_dates),
  iteration = "list"
)
```

* Format and save 7 day hierarchical nowcasts for hub submission.

```{targets save_hierarchical_submission}
tar_target(
  save_hierarchical_submission,
  save_csv(
    hierarchical_submission_nowcast,
      filename = paste0(nowcast_dates, ".csv"),
      path = here("data/nowcasts/submission/hierarchical")
  ),
  map(hierarchical_submission_nowcast, nowcast_dates),
  format = "file"
)
```

* Define and format the independent nowcast for submission.

```{targets independent_submission_nowcast}
tar_target(
  independent_submission_nowcast,
  independent_nowcast[nowcast_date == nowcast_dates]$seven_day |>
    rbindlist() |>
    format_for_submission(),
  map(nowcast_dates),
  iteration = "list"
)
```

* Format and save 7 day independent nowcasts for hub submission.

```{targets save_independent_submission}
tar_target(
  save_independent_submission,
  save_csv(
    independent_submission_nowcast,
    filename = paste0(nowcast_dates, ".csv"),
    path = here("data/nowcasts/submission/independent")
  ),
  map(nowcast_dates),
  format = "file"
)
```

* Save latest hospitalisation data 

```{targets save_latest_daily_hospitalisations}
tar_target(
  save_latest_daily_hospitalisations,
  save_csv(
    latest_hospitalisations,
    filename = paste0("daily.csv"),
    path = here("data/observations")
  ),
  format = "file"
)
```

* Save 7 day hospitalisation data

```{targets save_latest_7day_hospitalisations}
tar_target(
  save_latest_7day_hospitalisations,
  save_csv(
    latest_7day_hospitalisations,
    filename = paste0("seven_day.csv"),
    path = here("data/observations")
  ),
  format = "file"
)
```

# Evaluation

* Filter nowcasts to only include those with "complete" data (more than 28 days of reports) and with horizons between 0 days and -7 days from the nowcast date.

```{targets scored_nowcasts, tar_simple = TRUE}
summarised_nowcast[reference_date >= (report_date - 7)][
                   reference_date < (report_date - 28)][,
                   holiday := NULL][,
                   horizon := as.numeric(reference_date - report_date)]
```

* Score daily nowcasts overall, by location, by age group, and by horizon on both the natural and log scales (corresponding to absolute and relative scoring). These summarised scores are then saved to `data/scores`.

```{targets, score}
tar_map(
  list(score_by = c("overall", "location", "age_group", "horizon")),
  tar_target(
    scores,
    enw_score_nowcast(
      scored_nowcasts, complete_hospitalisations, 
      summarise_by = ifelse(score_by %in% "overall", "model", 
                            c(score_by, "model")),
      log = FALSE
    )
  ),
  tar_target(
    log_scores,
    enw_score_nowcast(
      scored_nowcasts, complete_hospitalisations, 
      summarise_by = ifelse(score_by %in% "overall", "model", 
                            c(score_by, "model")),
      log = TRUE
    )
  ),
  tar_target(
    save_scores,
    save_csv(
      rind(scores[, scale := "natural"], log_scores[, scale := "log"]),
      filename = paste0(score_by, ".csv"),
      path = here("data/scores")
    ),
    format = "file"
  )
)
```

# Visualise

* Plot most recent nowcast by location, age group, and model.

```{targets plot-latest-nowcast}
tar_target(
  plot_latest_nowcast,
  enw_plot_nowcast_quantiles(
    summarised_nowcast[nowcast_date == max(nowcast_date)][
                       location == locations][
                       reference_date >= (nowcast_date - 28)], 
    latest_obs = latest_hospitalisations[location == locations][
                                         reference_date >= (max(report_date) - 
                                                             40)]
  ) +
  facet_grid(vars(age_group), vars(model), scales = "free_y"),
  map(locations)
)
```

* Plot nowcasts at 0 horizon by location, age group, and model.

* Plot nowcasts at 3 day horizon by location, age group and model

* Plot scores relative to the baseline by location and age group on both the natural and log scale.

# Reporting

* Render nowcast report.
