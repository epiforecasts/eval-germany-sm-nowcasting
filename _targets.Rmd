---
title: "Supplementary information"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```


# Setup

Set up the workflow pipeline and options. We first load the `targets` package and remove the potentially outdated workflow.

```{r}
library(targets)
library(tarchetypes)
library(data.table)
library(epinowcast)
library(ggplot2)
library(purrr)
library(here)
tar_unscript()
```

We now define shared global options across our workflow and load R functions from the `R` folder.


```{targets globals, tar_globals = TRUE}
library(targets)
library(tarchetypes)
library(data.table)
library(epinowcast)
library(ggplot2)
library(purrr)
library(here)
functions <- list.files(here("R"), full.names = TRUE)
walk(functions, source)
tar_option_set(
  packages = c("data.table", "epinowcast", "scoringutils", "ggplot2", "purrr",
               "cmdstanr"),
  deployment = "worker",
  memory = "transient",
  workspace_on_error = TRUE,
  error = "continue",
  garbage_collection = TRUE
)
```

# Ingest data and stratify by location and report date

* Specify todays date to trigger downloading new data.

```{targets today, tar_globals = TRUE}
today <- Sys.Date()
```
* Download and process hospitalisation data.

```{targets hospitalisations, tar_simple = TRUE}
get_germany_hospitalisations(today)
```

* Download and process public holidays data.

* Define dates to nowcast.

```{targets nowcast_dates, tar_simple = TRUE}
unique(
  hospitalisations[reference_date >= as.Date("2021-09-01")]$reference_date
)[1:2]
```

* Define age groups

```{targets age_groups, tar_simple = TRUE}
unique(hospitalisations$age_group)
```

* Define locations to nowcast

```{targets locations, tar_simple = TRUE}
unique(hospitalisations$location)[1:2]
```

* Define maximum allowed reporting delay (in days).

```{targets max_report_delay, tar_simple = TRUE}
40
```

* Define hospitalisations by date of report

```{targets hospitalisations_by_date_report}
tar_target(
  hospitalisations_by_date_report,
  enw_retrospective_data(
    hospitalisations, rep_date = nowcast_dates,
    ref_days = max_report_delay
  )[, nowcast_date := nowcast_dates],
  map(nowcast_dates),
  iteration = "list"
)
```

* Define latest available data.

```{targets latest_hospitalisations, tar_simple = TRUE}
 enw_latest_data(hospitalisations)
```

* Make latest observations into 7 day incidence.

```{targets, latest_7day_hospitalisations, tar_simple = TRUE}
copy(latest_hospitalisations)[,
  confirm := frollsum(confirm, n =  7), by = c("age_group", "location")
][!is.na(confirm)]
```

* Plot reporting delay percentage by date, location, and age group.

# Fit models and produce nowcasts

## Model and model settings

* Compile the model for multithread use.

```{targets, epinowcast_model}
tar_target(
  epinowcast_model,
  compile_model(),
  format = "file", deployment = "main",
)
```
* Define stan settings shared across models and used for fitting

```{targets epinowcast_settings, tar_simple = TRUE}
list(
  save_warmup = FALSE,
  output_loglik = FALSE,
  pp = FALSE,
  iter_warmup = 1000,
  iter_sampling = 1000,
  chains = 2,
  parallel_chains = 2,
  threads_per_chain = 2,
  adapt_delta = 0.8,
  show_messages = FALSE,
  refresh = 0
)
```

## Priors

* Define a set of uninformed priors using the defaults from `epinowcast`.

```{targets uninformed_priors, tar_simple = TRUE}
enw_priors()
```

* Define a set of observations to use as a source for informed priors. Here we use overall national hospitalisations and data from the 1st of September 2021.

```{targets prior_obs, tar_simple = TRUE}
enw_retrospective_data(
  hospitalisations[location == "DE"][age_group == "00+"],
  rep_date = as.Date("2021-09-01"), ref_days = max_report_delay
)
```

* Fit a model to national overall hospitalisations only and extract posterior estimates for the delay distribution and overdispersion to use as informed priors for other models by assuming a normal distribution with their posterior standard deviations scaled by 5 times.

```{targets priors, tar_simple = TRUE} 
do.call(prior_epinowcast, c(
  list(
    prior_obs, max_delay = max_report_delay, scale = 5,
    priors = uninformed_priors
  ),
  epinowcast_settings
))
```

## Models

* Intercept only model.

```{targets, fixed_nowcast}
tar_target(
  fixed_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = fixed_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Intercept model with day of the week reporting effects.

```{r, dow_nowcast, eval = FALSE}
tar_target(
  dow_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = dow_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with day of the week effect reporting effects.

```{r, age_nowcast, eval = FALSE}
tar_target(
  age_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = age_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with a weekly random walk and a day of the week reporting effect.

```{r, week_nowcast, eval = FALSE}
tar_target(
  week_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = week_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Age group random effect model with a weekly random walk, an age group specific weekly random walk in the residuals,  and a day of the week reporting effect.

```{r, age_week_nowcast, eval = FALSE}
tar_target(
  age_week_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report,
    tar_loc = locations,
    model = age_week_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations)
)
```

* Independent age group model with a weekly random walk and a day of the week reporting model.

```{r, independent_nowcast, eval = FALSE}
tar_target(
  independent_nowcast,
  nowcast(
    obs = hospitalisations_by_date_report[age_group == age_groups],
    tar_loc = locations,
    model = independent_epinowcast,
    priors = priors,
    max_delay = max_report_delay,
    settings = epinowcast_settings
  ),
  cross(hospitalisations_by_date_report, locations, age_groups)
)
```

# Postprocess

* Save nowcasts stratified by nowcasting date.

* Format 7 day nowcasts for hub submission.

* Save 7 day nowcasts formatted for hub submission.

* Save latest hospitalisation data 

* Save 7 day hospitalisation data

# Visualise

* Plot most recent nowcast by location, age group, and model.

* Plot nowcasts at 0 horizon by location, age group, and model.

* Plot nowcasts at 3 day horizon by location, age group and model

# Evaluation

* Score nowcasts overall both on a natural scale and on a log scale.

* Score nowcasts by location on a natural scale and on a log scale.

* Score nowcasts by age group on a natural scale and on a log scale.

* Score nowcasts by horizon on a natural scale and on a log scale.

* Plot scores relative to the baseline by location and age group on both the natural and log scale.

# Reporting

* Render nowcast report.

# Pipeline

The pipeline can be regenerated by rendering this file,

```{r, eval = FALSE}
rmarkdown::render("_targets.Rmd")
```

The pipeline can then be run using,

```{r, eval = FALSE}
tar_make()
```

The complete pipeline can be visualised using,

```{r, eval = FALSE}
tar_visnetwork()
```

The pipeline can be regenerated and run using the following single step

```{bash, eval = FALSE}
. _targets.sh
```

Alternatively the pipeline can be explored interactively using this notebook.
