---
title: "Evaluating Semi-Parametric Nowcasts of COVID-19 Hospital Admissions in Germany"
subtitle: "Real-time evaluation and current nowcasts"
author: Sam Abbott 
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dpi = 330, warning = FALSE)
library(knitr)
library(here)
library(data.table)
library(DT)
library(janitor)
library(purrr)
library(ggplot2)
library(plotly)
library(crosstalk)
source(here("R", "utils.R"))
source(here("R", "plot.R"))
```

# Summary

- Outline the aim.
- Discuss and link out to the hub ensemble.
- Discuss the general method and link out to more details in `epinowcast`.
- Discuss the specifics of the models deployed here for each target.
- Outline the sections of this report (visualisation, evaluation and diagnostics).

# Visualisation

In the following sections nowcasts are visualised by forecast date and then by horizon for all models considered. Visualising by nowcast date corresponds to plotting a real-time nowcast whilst plotting by horizon is useful for understanding the performance of nowcasting models across a number of forecasts in a concise way.

## Nowcast

```{r load-nowcasts}
daily_nowcasts <- load_nowcasts(here("data", "nowcasts", "daily"))
daily_nowcasts[, mean := NA][, median := NA]

seven_day_nowcasts <- load_nowcasts(here("data", "nowcasts", "seven_day"))

latest_hosp <- fread(here("data", "observations", "daily.csv"))
latest_seven_day_hosp <- fread(here("data", "observations", "seven_day.csv"))
```

Plot latest nowcasts by location, age group and model.

### National

```{r latest-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  daily_nowcasts[location == "DE"][
                 nowcast_date == max(nowcast_date)][,
                 confirm := NA],
  latest_hosp[location == "DE"],
  max_delay = 28
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Sub-national

```{r latest-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  daily_nowcasts[!(location == "DE")][
                 nowcast_date == max(nowcast_date)][,
                 confirm := NA],
  latest_hosp[!(location == "DE")][age_group == "00+"],
  max_delay = 28
) +
  facet_wrap(vars(location), scales = "free_y")
```

## Nowcast by horizon

Plot nowcasts at the date of forecast by location, age group and model.

### National

```{r horizon-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  daily_nowcasts[location == "DE"][
                 horizon == 0][,
                 confirm := NA],
  latest_hosp[location == "DE"]
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Subnational

```{r horizon-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  daily_nowcasts[!(location == "DE")][
                 horizon == 0][,
                 confirm := NA],
  latest_hosp[!(location == "DE")][age_group == "00+"]
) +
  facet_wrap(vars(location), scales = "free_y")
```

# Evaluation

In this section we evaluate and compare the peformance of each nowcasting model using proper scoring rules on both the natural and the log scale. This corresponds to evaluating absolute and relative error. Only nowcasts from the national level are considered as sub-national nowcasts are not available for all models. For evaluation we consider only forecast targets for which the data is minimally informative which we defined as the 7 days prior to the date of the nowcast. We explore overall scores as well as scores stratified by age group and by nowcast horizon.

## Overall nowcast model scores

```{r load-overall-scores}
scores <- fread(here("data/scores/overall.csv"))
scores <- clean_names(scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r overall-scores}
kable(scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-overall-scores}
kable(scores[Scale == "log"][, Scale := NULL])
```

## Nowcast model scores by horizon

```{r load-horizon-scores}
horizon_scores <- fread(here("data/scores/horizon.csv"))
horizon_scores <- clean_names(horizon_scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r horizon-scores}
fancy_datatable(horizon_scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-horizon-scores}
fancy_datatable(horizon_scores[Scale == "log"][, Scale := NULL])
```

## Nowcast model scores by age group

```{r load-age-group-scores}
age_group_scores <- fread(here("data/scores/age_group.csv"))
age_group_scores <- clean_names(age_group_scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r age-group-scores}
fancy_datatable(age_group_scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-age-group-scores}
fancy_datatable(age_group_scores[Scale == "log"][, Scale := NULL])
```

# Diagnostics

This section summarises model fitting diagnostics. Whilst most model fits successfully a small subset have issues for as yet unidentified reasons. These issues can be split into issues with convergence and issues with exploring the posterior distribution (often leading to unreliable posterior samples). Resolving these issues is an area of [active research](https://github.com/epiforecasts/epinowcast/issues/22). Finally, model run-time is also summarised for national level nowcasts.


## Convergence issues

```{r rhat}
rhat <- fread(here("data/diagnostics/high-rhat.csv"))
fancy_datatable(rhat)
```

## Divergent transitions


```{r dts}
dts <- fread(here("data/diagnostics/high-divergent-transitions.csv"))
fancy_datatable(dts)
```

## Run time

```{r run-time}
run_time <- fread(here("data/diagnostics/all.csv"))
run_time <- run_time
```

# References