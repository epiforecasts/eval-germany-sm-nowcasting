---
title: "Evaluating Semi-Parametric Nowcasts of COVID-19 Hospital Admissions in Germany"
subtitle: "Real-time comparison to other nowcasting hub methods"
author: Sam Abbott 
bibliography: ../../writeup/library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: ../header.html
      after_body: ../footer.html
---

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dpi = 330, warning = FALSE)
library(knitr)
library(here)
library(data.table)
library(DT)
library(janitor)
library(purrr)
library(ggplot2)

source(here("R", "utils.R"))
source(here("R", "plot.R"))
source(here("R", "get-hub-forecasts.R"))
```

# Introduction

In this real time evaluation report we provide preliminary visualisations, evaluation, and exploration of our nowcasting methodology [@epinowcast] for COVID-19 hospitalisations in Germany by date of postive test. For more details of our methodology and the specifics of the models shown in this report please see our [project summary](https://epiforecasts.io/eval-germany-sp-nowcasting/) and our accompanying [paper](https://epiforecasts.io/eval-germany-sp-nowcasting/paper.pdf) for full method details. This report is updated each day (at roughly 9:00 GMT) as new data and nowcasts become available and may evolve over time. See our [news section](https://github.com/epiforecasts/eval-germany-sp-nowcasting/blob/main/NEWS.md) for a list of dated changes.

We first visualise current nowcasts across models and age groups at the national level as well as overall at the subnational level. We also plot nowcasts at the date of estimation across sequential nowcasts allowing us to summarise the performance of multiple nowcasts on a single plot, again for age groups at the national level and overall at the subnational level. 

To quantify comparative performance we make use of proper scoring rules [@scoringutils] on both the natural and log scales (corresponding to absolute and relative performance) aggregating scores first across all targets and then stratifying in turn by age group, nowcast horizon, date of postive test, and date of report. See Bosse et al. [@scoringutils] for information on how to interpret these scores.

To explore other aspects of our models performance we highlight models that have problematic fitting diagnostics and summarise the estimation time for each model. To learn more about the model fitting diagnostics we use here see [@stan] and [@cmdstanr].

The code for this report can be found [here](https://github.com/epiforecasts/eval-germany-sp-nowcasting/blob/main/docs/real-time/index.Rmd) and the data that it uses can be found [here](https://github.com/epiforecasts/eval-germany-sp-nowcasting/tree/main/data).

# Visualisation

In the following sections nowcasts are visualised for the latest estimation date and then by estimation date for all models considered. Visualising a nowcast from a single estimation date corresponds to plotting a real-time nowcast whilst plotting across estimation dates for that date is useful for understanding the performance of nowcasting models across a number of nowcasts in a concise way. 

## Nowcasts

Nowcasts based on the latest available data by age group on the national level and overall on the subnational level.

```{r load-nowcasts}
start_using_memoise(".cache")
nowcast_dates <- seq(as.Date("2021-11-22"), Sys.Date(), by = "day")
hub_nowcasts <- get_hub_forecasts(
  "KITmetricslab/hospitalization-nowcast-hub",
  dates = nowcast_dates
)
hub_nowcasts <- format_hub_nowcasts(hub_nowcasts)

latest_seven_day_hosp <- load_obs(here("data", "observations", "seven_day.csv"))
complete_seven_day_hosp <- latest_seven_day_hosp[
  reference_date < (max(reference_date) - 14)
][]
```

### National

```{r latest-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  hub_nowcasts[location == "DE"][
               nowcast_date == max(nowcast_date)] |>
  map_to_dummy_quantiles(),
  latest_seven_day_hosp[location == "DE"],
  max_delay = 28
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Sub-national

```{r latest-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  hub_nowcasts[!(location == "DE")][
                 nowcast_date == max(nowcast_date)] |>
  map_to_dummy_quantiles(),
  latest_seven_day_hosp[!(location == "DE")][age_group == "00+"],
  max_delay = 28
) +
  facet_wrap(vars(location), scales = "free_y")
```

## Nowcasts at estimation date

Nowcast estimates at the date of estimation for sequential nowcasts by age group at the national level and overall at the subnational level.

### National

```{r horizon-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  hub_nowcasts[location == "DE"][
               horizon == 0] |>
  map_to_dummy_quantiles(),
  latest_seven_day_hosp[location == "DE"],
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Subnational

```{r horizon-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  hub_nowcasts[!(location == "DE")][
               horizon == 0] |>
  map_to_dummy_quantiles(),
  latest_seven_day_hosp[!(location == "DE")][age_group == "00+"]
) +
  facet_wrap(vars(location), scales = "free_y")
```

# Evaluation

In this section we evaluate and compare the performance of each nowcasting model using proper scoring rules [@scoringutils] on both the natural and the log scale. This corresponds to evaluating absolute and relative error. Only nowcasts from the national level are considered as sub-national nowcasts are not available for all models. For evaluation we consider only forecast targets for which the data is minimally informative which we defined as the 7 days prior to the date of the nowcast. We explore overall scores as well as scores stratified by age group, by nowcast horizon, and by date of postive test, and by report date.

## Overall nowcast model scores

```{r load-overall-scores}
scores <- score_nowcast(hub_nowcasts, complete_seven_day_hosp)
```

### Natural scale scores (absolute)

```{r overall-scores}
fancy_datatable(scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-overall-scores}
fancy_datatable(scores[scale == "log"][, scale := NULL])
```

## Nowcast model scores by horizon

```{r load-horizon-scores}
horizon_scores <- score_nowcast(
  hub_nowcasts, complete_seven_day_hosp, by = c("horizon", "model")
)
```

```{r plot-horizon, fig.height = 4, fig.width = 8}
plot_scores(
  horizon_scores, y = interval_score, x = horizon, col = model, fill = model,
  group = model
) +
  facet_wrap(vars(scale), scales = "free_y") +
  labs(x = "Nowcast horizon (with 0 being the date of nowcast)")
```

### Natural scale scores (absolute)

```{r horizon-scores}
fancy_datatable(horizon_scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-horizon-scores}
fancy_datatable(horizon_scores[scale == "log"][, scale := NULL])
```

## Nowcast model scores by age group

```{r load-age-group-scores}
age_group_scores <- score_nowcast(
  hub_nowcasts, complete_seven_day_hosp, by = c("age_group", "model")
)
```

```{r plot-age-group, fig.height = 4, fig.width = 8}
plot_scores(
  age_group_scores, y = interval_score, x = age_group, col = model,
  fill = model, group = model
) +
  facet_wrap(vars(scale), scales = "free_y") +
  labs(x = "Age group")
```

### Natural scale scores (absolute)

```{r age-group-scores}
fancy_datatable(age_group_scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-age-group-scores}
fancy_datatable(age_group_scores[scale == "log"][, scale := NULL])
```

## Nowcast model scores by date of positive test

```{r load-ref-date-scores}
reference_date_scores <- score_nowcast(
  hub_nowcasts, complete_seven_day_hosp, by = c("reference_date", "model")
)
```

```{r plot-ref-date, fig.height = 8, fig.width = 8}
plot_scores(
  reference_date_scores, y = interval_score, x = reference_date, col = model,
  fill = model, group = model
) +
  facet_wrap(vars(scale), scales = "free_y") +
  labs(x = "Reference date")
```

### Natural scale scores (absolute)

```{r ref-date-scores}
fancy_datatable(reference_date_scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-ref-date-scores}
fancy_datatable(reference_date_scores[scale == "log"][, scale := NULL])
```

## Nowcast model scores by report date

```{r load-rep-date-scores}
report_date_scores <- age_group_scores <- score_nowcast(
  hub_nowcasts, complete_seven_day_hosp, by = c("nowcast_date", "model")
)
```


```{r plot-rep-date, fig.height = 8, fig.width = 8}
plot_scores(
  report_date_scores, y = interval_score, x = nowcast_date, col = model,
  fill = model, group = model
) +
  facet_wrap(vars(scale), scales = "free_y") +
  labs(x = "Report date")
```


### Natural scale scores (absolute)

```{r rep-date-scores}
fancy_datatable(report_date_scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-rep-date-scores}
fancy_datatable(report_date_scores[scale == "log"][, scale := NULL])
```

## Nowcast model scores by location

```{r load-location-scores}
location_scores <- score_nowcast(
  hub_nowcasts, complete_seven_day_hosp, by = c("location", "model")
)
```


```{r plot-location-scores, fig.height = 8, fig.width = 8}
plot_scores(
  location_scores, y = interval_score, x = location, col = model,
  fill = model, group = model
) +
  facet_wrap(vars(scale), scales = "free_y") +
  labs(x = "Location")
```

### Natural scale scores (absolute)

```{r location-scores}
fancy_datatable(location_scores[scale == "natural"][, scale := NULL])
```

### Log scale scores (relative)

```{r relative-location-scores}
fancy_datatable(location_scores[scale == "log"][, scale := NULL])
```

# References