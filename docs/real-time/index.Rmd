---
title: "Evaluating Semi-Parametric Nowcasts of COVID-19 Hospital Admissions in Germany"
subtitle: "Real-time evaluation and current nowcasts"
author: Sam Abbott 
bibliography: ../../writeup/library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: ../header.html
      after_body: ../footer.html
---

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dpi = 330, warning = FALSE)
library(knitr)
library(here)
library(data.table)
library(DT)
library(janitor)
library(purrr)
library(ggplot2)
library(plotly)
library(crosstalk)
source(here("R", "utils.R"))
source(here("R", "plot.R"))
```

# Introduction

In this real time evaluation report we provide preliminary visualisations, evaluation, and exploration of our nowcasting methodology [@epinowcast] for COVID-19 hospitalisations in Germany by date of postive test. For more details of our methodology and the specifics of the models shown in this report please see our [project summary]() and our accompanying [paper]() for full method details. This report is updated each day (at roughly 9:00 GMT) as new data and nowcasts become available and may evolve over time. See our [news section](https://github.com/epiforecasts/eval-germany-sp-nowcasting/blob/main/NEWS.md) for a list of dated changes.

We first visualise current nowcasts across models and age groups at the national level as well as overall at the subnational level. We also plot nowcasts at the date of estimation across sequential nowcasts allowing us to summarise the performance of multiple nowcasts on a single plot, again for age groups at the national level and overall at the subnational level. 

To quantify comparative performance we make use of proper scoring rules [@scoringutils] on both the natural and log scales (corresponding to absolute and relative performance) aggregating scores first across all targets and then stratifying in turn by age group, nowcast horizon, date of postive test, and date of report.

To explore other aspects of our models performance we 
Note that for national data stratified by age we considered a range of models that are summarised [here]() and fully defined [here]().

# Visualisation

In the following sections nowcasts are visualised for the latest estimation date and then by estimation date for all models considered. Visualising a nowcast from a single estimation date corresponds to plotting a real-time nowcast whilst plotting across estimation dates for that date is useful for understanding the performance of nowcasting models across a number of nowcasts in a concise way. 

## Nowcast

Nowcasts for the latest available data by age group on the national level and overall on the subnational level.

```{r load-nowcasts}
daily_nowcasts <- load_nowcasts(here("data", "nowcasts", "daily"))
daily_nowcasts[, mean := NA][, median := NA]

seven_day_nowcasts <- load_nowcasts(here("data", "nowcasts", "seven_day"))

latest_hosp <- load_obs(here("data", "observations", "daily.csv"))
latest_seven_day_hosp <- load_obs(here("data", "observations", "seven_day.csv"))
```

### National

```{r latest-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  daily_nowcasts[location == "DE"][
                 nowcast_date == max(nowcast_date)][,
                 confirm := NA],
  latest_hosp[location == "DE"],
  max_delay = 28
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Sub-national

```{r latest-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  daily_nowcasts[!(location == "DE")][
                 nowcast_date == max(nowcast_date)][,
                 confirm := NA],
  latest_hosp[!(location == "DE")][age_group == "00+"],
  max_delay = 28
) +
  facet_wrap(vars(location), scales = "free_y")
```

## Nowcast at estimation date

Nowcast estimates at the day of estimation across sequential nowcasts by age group at the national level and overall at the subnational level.

### National

```{r horizon-national-nowcast, fig.width = 24, fig.height = 16}
plot_nowcast(
  daily_nowcasts[location == "DE"][
                 horizon == 0][,
                 confirm := NA],
  latest_hosp[location == "DE"]
) +
  facet_grid(vars(age_group), vars(model), scales = "free_y")
```

### Subnational

```{r horizon-subnational-nowcast, fig.width = 16, fig.height = 16}
plot_nowcast(
  daily_nowcasts[!(location == "DE")][
                 horizon == 0][,
                 confirm := NA],
  latest_hosp[!(location == "DE")][age_group == "00+"]
) +
  facet_wrap(vars(location), scales = "free_y")
```

# Evaluation

In this section we evaluate and compare the peformance of each nowcasting model using proper scoring rules [@scoringutls] on both the natural and the log scale. This corresponds to evaluating absolute and relative error. Only nowcasts from the national level are considered as sub-national nowcasts are not available for all models. For evaluation we consider only forecast targets for which the data is minimally informative which we defined as the 7 days prior to the date of the nowcast. We explore overall scores as well as scores stratified by age group, by nowcast horizon, by date of postive test, and by report date.

## Overall nowcast model scores

```{r load-overall-scores}
scores <- fread(here("data/scores/overall.csv"))
scores <- clean_names(scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r overall-scores}
kable(scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-overall-scores}
kable(scores[Scale == "log"][, Scale := NULL])
```

## Nowcast model scores by horizon

```{r load-horizon-scores}
horizon_scores <- fread(here("data/scores/horizon.csv"))
horizon_scores <- clean_names(horizon_scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r horizon-scores}
fancy_datatable(horizon_scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-horizon-scores}
fancy_datatable(horizon_scores[Scale == "log"][, Scale := NULL])
```

## Nowcast model scores by age group

```{r load-age-group-scores}
age_group_scores <- fread(here("data/scores/age_group.csv"))
age_group_scores <- clean_names(age_group_scores, case = "sentence")
```

### Natural scale scores (absolute)

```{r age-group-scores}
fancy_datatable(age_group_scores[Scale == "natural"][, Scale := NULL])
```

### Log scale scores (relative)

```{r relative-age-group-scores}
fancy_datatable(age_group_scores[Scale == "log"][, Scale := NULL])
```

# Diagnostics

This section summarises model fitting diagnostics. Whilst most model fits successfully a small subset have issues for as yet unidentified reasons. These issues can be split into issues with convergence and issues with exploring the posterior distribution (often leading to unreliable posterior samples). Resolving these issues is an area of [active research](https://github.com/epiforecasts/epinowcast/issues/22). Finally, model run-time is also summarised for national level nowcasts.

## Convergence issues

```{r rhat}
rhat <- fread(here("data/diagnostics/high-rhat.csv"))
fancy_datatable(rhat)
```

## Divergent transitions

```{r dts}
dts <- fread(here("data/diagnostics/high-divergent-transitions.csv"))
fancy_datatable(dts)
```

## Run time

In the this section, we summarise the run time of each nowcasting model using 2 cores each on a standard Azure virtual machine. These run-times are indicative only but the relative difference between models should hold across machines. To make the independent model run times comparable with other models we have combined the run time across all age groups. However, this model is naively parallel and so could in theory be run on separate compute nodes per age group (so as we have 7 age groups this would result in a 7 times speed up). As all models make use of the support in `stan` for within chain parallisation all models could also be estimated with significantly reduced run time with the allocation of increased compute resources.
s 
```{r run-time}
run_time <- fread(here("data/diagnostics/all.csv"))
run_time <- run_time
```

# References